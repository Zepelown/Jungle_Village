{% extends "base_main.html" %}

{% block title %}í™ˆ{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/writing.css') }}" />
<link rel="stylesheet" href="{{ url_for('static', filename='css/comment.css') }}" />
{% endblock %}

{% block script %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        $(".reply-toggle").click(function () {
            const replyInput = $(this).closest(".comment").find(".reply-input");
            replyInput.toggleClass("d-none");
        });

        $(".reply-cancel").click(function () {
            $(this).closest(".reply-input").addClass("d-none");
        });

        $(".reply-submit").click(function () {
            const commentDiv = $(this).closest(".comment");  // .comment ìš”ì†Œë¥¼ ì°¾ì•„ì•¼ í•¨
            const commentId = commentDiv.attr("data-comment-id");  // .commentì—ì„œ data-comment-id ê°€ì ¸ì˜´
            const replyInput = commentDiv.find(".reply-input textarea");

            console.log("ì „ì†¡ë˜ëŠ” comment_id:", commentId);  // ğŸ›  ë””ë²„ê¹… ì½”ë“œ
            console.log("ì „ì†¡ë˜ëŠ” ë‹µê¸€ ë‚´ìš©:", replyInput);

            if (!commentId) {
                console.error("Error: ëŒ“ê¸€ IDê°€ ì—†ìŒ!");
                alert("ëŒ“ê¸€ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            // input ìš”ì†Œê°€ ì œëŒ€ë¡œ ì„ íƒë˜ì—ˆëŠ”ì§€ í™•ì¸
            if (!replyInput.length) {
                console.error("Error: replyInput ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ!");
                return;
            }

            const replyText = replyInput.val()?.trim(); // `?.`ë¥¼ ì‚¬ìš©í•˜ì—¬ undefi

            if (replyText === "") {
                alert("ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”!");
                return;
            }

            $.ajax({
                url: "/reply",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    comment_id: commentId,
                    user_id: "67cfb44b8c8918f658c51832", // ì‹¤ì œ ë¡œê·¸ì¸ëœ ì‚¬ìš©ì IDë¡œ ë³€ê²½ í•„ìš”
                    content: replyText
                }),
                success: function (response) {
                    location.reload();
                },
                error: function (xhr) {
                    alert("ë‹µê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + xhr.responseJSON.error);
                }
            });
        });

        $(".comment-sumbit").click(function () {
            const commentDiv = $(this).closest(".comment-write-section");  // data-article-id
            const article_id = commentDiv.attr("data-article-id");
            const commentInput = commentDiv.find(".comment-input textarea");
            console.log("ì „ì†¡ë˜ëŠ” ëŒ“ê¸€ ë‚´ìš©:", commentInput);

            if (!article_id) {
                console.error("Error: ëŒ“ê¸€ IDê°€ ì—†ìŒ!");
                alert("ëŒ“ê¸€ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            // input ìš”ì†Œê°€ ì œëŒ€ë¡œ ì„ íƒë˜ì—ˆëŠ”ì§€ í™•ì¸
            if (!commentInput.length) {
                console.error("Error: commentInput ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ!");
                return;
            }

            const commentText = commentInput.val()?.trim(); // `?.`ë¥¼ ì‚¬ìš©í•˜ì—¬ undefi

            if (commentText === "") {
                alert("ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”!");
                return;
            }

            $.ajax({
                url: "/comment",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    article_id: article_id,
                    content: commentText
                }),
                success: function (response) {
                    location.reload();
                },
                error: function (xhr) {
                    alert("ëŒ“ê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + xhr.responseJSON.error);
                }
            });
        });

        $(".comment-delete-toggle").click(function () {
            const commentDiv = $(this).closest(".comment");  // .comment ìš”ì†Œë¥¼ ì°¾ì•„ì•¼ í•¨
            const commentId = commentDiv.attr("data-comment-id");  // .commentì—ì„œ data-comment-id ê°€ì ¸ì˜´
            $.ajax({
                url: "/comment",
                method: "DELETE",
                contentType: "application/json",
                data: JSON.stringify({
                    comment_id: commentId,
                }),
                success: function (response) {
                    location.reload();
                },
                error: function (xhr) {
                    alert("ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + xhr.responseJSON.error);
                }
            });
        });

        $(".reply-delete-toggle").click(function () {
            const commentDiv = $(this).closest(".comment");
            const commentId = commentDiv.attr("data-comment-id");
            const replyDiv = $(this).closest(".reply");
            const replyId = replyDiv.attr("data-reply-id");
            $.ajax({
                url: "/reply",
                method: "DELETE",
                contentType: "application/json",
                data: JSON.stringify({
                    user_id: "67cfb44b8c8918f658c51832", // ì‹¤ì œ ë¡œê·¸ì¸ëœ ì‚¬ìš©ì IDë¡œ ë³€ê²½ í•„ìš”
                    reply_id: replyId,
                    comment_id: commentId
                }),
                success: function (response) {
                    location.reload();
                },
                error: function (xhr) {
                    alert("ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + xhr.responseJSON.error);
                }
            });
        });
    });

</script>



{% endblock %}


{% block content %}
<div class="right-section flex-column">
    <div class="article-container p-4 mb-4 rounded-3">
        <div class="d-flex justify-content-between align-items-end">
            <h3 class="article-title m-0">
                <a href="{{ url_for('articles.article_detail', article_id=article['_id']) }}"
                    class="text-decoration-none fw-bold text-dark">
                    {{ article['title'] }}
                </a>
            </h3>
            <p class="edit-article m-0 ms-3 text-primary fw-semibold" role="button">
                <a href="{{ url_for('articles.edit_get', article_id=article['_id']) }}"
                    class="">
                    ìˆ˜ì •í•˜ê¸°
                </a>


            </p>
        </div>

        <div class="article-meta mb-3 text-muted">
            <span>ì‘ì„±ì | {{ writer['generation'] }}ê¸° {{ writer['nickname'] }}</span>
            <span class="mx-2">|</span>
            <span>ì‘ì„±ì¼ì | {{ article['date'] }}</span>
        </div>
        <p class="article-content">{{ article['content'] }}</p>

        {% if article['images'] %}
        <div class="article-images mb-4">
            <div class="d-flex justify-content-start" style="overflow-x: auto; white-space: nowrap;">
                {% for image in article['images'] %}
                <img src="{{ image }}" class="img-fluid me-2 ml-1" alt="Article Image"
                    style="height: auto; object-fit: contain; max-height: 300px; width: 100%;">
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- ëŒ“ê¸€ ì„¹ì…˜ -->
    {% if comments %}
    <div class="comments-section">
        <h5 class="comments-title mb-3">ëŒ“ê¸€ ({{ total_comments }})</h5>
        <div class="d-flex flex-column">
            {% for comment in comments %}
            <div class="comment mb-3 p-3 rounded-3 shadow-sm" data-comment-id="{{ comment['_id'] }}">
                <div class="d-flex align-items-center  p-2 rounded-2">
                    <img src="{{ comment['user_info']['profile_image'] }}" class="comment-profile img-fluid me-3"
                        alt="Commenter Image">
                    <div class="ml-1 flex-grow-1">
                        <div>
                            <strong>{{ comment['user_info']['generation'] }}ê¸° {{ comment['user_info']['nickname']
                                }}</strong>
                            <button class="reply-btn reply-toggle ml-1" data-comment-id="{{ comment['_id'] }}">
                                ë‹µê¸€ ì“°ê¸°
                            </button>
                            <button class="delete-btn comment-delete-toggle ml-1">ì‚­ì œ</button>
                        </div>
                        <p class="comment-text mt-2">{{ comment['content'] }}</p>
                    </div>
                </div>

                <!-- ê¸°ì¡´ ëŒ€ëŒ“ê¸€ í‘œì‹œ -->
                {% if comment['replies'] %}
                <div class="replies mt-3 ms-5">
                    {% for reply in comment['replies'] %}
                    <div class="reply d-flex align-items-center  p-2 mb-2 rounded-2" data-reply-id="{{ reply['_id']}}">
                        <img src="{{ reply['user_info']['profile_image'] }}" class="reply-profile img-fluid me-3"
                            alt="Reply Image">
                        <div class="ml-1">
                            <div>
                                <strong>{{ reply['user_info']['generation'] }}ê¸° {{
                                    reply['user_info']['nickname']}}</strong>
                                <button class="delete-btn reply-delete-toggle ml-1">ì‚­ì œ</button>
                            </div>
                            <p class="reply-text mt-2">{{ reply['content'] }}</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- ìˆ¨ê²¨ì§„ ë‹µê¸€ ì…ë ¥ì°½ -->
                <div class="reply-input mt-3 ms-5 p-2 bg-white rounded shadow-sm d-none"
                    id="reply-input-{{ comment['_id'] }}">
                    <div class="d-flex align-items-start">
                        <img src="{{ writer['profile_image'] }}" class="rounded-circle me-2" alt="Profile Image"
                            width="50" height="50">
                        <textarea class="form-control" rows="2" placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                        <div class="d-flex justify-content-end mt-2">
                            <button class="btn btn-sm btn-outline-secondary reply-cancel">ì·¨ì†Œ</button>
                            <button class="btn btn-sm btn-primary ms-2 reply-submit">ë‹µê¸€ ì‘ì„±</button>
                        </div>

                    </div>

                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="comment-write-section p-3 rounded shadow-sm bg-light" data-article-id="{{article['_id']}}">
        <div class="d-flex align-items-start">
            <!-- í”„ë¡œí•„ ì´ë¯¸ì§€ -->
            <img src="{{ user['profile_image'] }}" class="rounded-circle me-2" alt="Profile Image" width="50"
                height="50">

            <!-- ì…ë ¥ í•„ë“œ -->
            <div class="comment-input flex-grow-1 ml-1">
                <textarea class="form-control" id="commentInput" rows="2" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
            </div>
        </div>

        <!-- ë²„íŠ¼ ì˜ì—­ -->
        <div class="d-flex justify-content-end mt-2">
            <button class="btn btn-primary comment-sumbit">ëŒ“ê¸€ ì‘ì„±</button>
        </div>
    </div>
</div>
{% endblock %}